#!/bin/bash

# ===============================================================================
# ForceQUIT - Test Automation Script
# SWARM 2.0 Framework - BUILD_SYSTEM_DEVELOPER
# ===============================================================================
# Quick test automation for local development
# Supports: Watch mode, continuous integration, pre-commit hooks

set -e

# Configuration
PROJECT_NAME="ForceQUIT"
WATCH_MODE=false
CONTINUOUS_MODE=false
PRE_COMMIT_MODE=false

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --watch)
            WATCH_MODE=true
            shift
            ;;
        --continuous)
            CONTINUOUS_MODE=true
            shift
            ;;
        --pre-commit)
            PRE_COMMIT_MODE=true
            shift
            ;;
        *)
            echo "Usage: $0 [--watch|--continuous|--pre-commit]"
            exit 1
            ;;
    esac
done

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log() {
    echo -e "${BLUE}[TEST AUTOMATION]${NC} $1"
}

success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Run quick test suite
run_quick_tests() {
    log "ðŸš€ Running quick test suite..."
    
    # Make test suite executable
    chmod +x swift-test-suite.sh
    
    if [[ "$PRE_COMMIT_MODE" == true ]]; then
        # Pre-commit: run only unit tests
        ./swift-test-suite.sh --unit-only --fail-fast
    else
        # Regular: run all tests
        ./swift-test-suite.sh --verbose
    fi
    
    return $?
}

# Watch mode - monitor file changes
watch_mode() {
    log "ðŸ‘€ Starting watch mode..."
    log "Monitoring changes in Sources/ and Tests/"
    
    if ! command -v fswatch &> /dev/null; then
        error "fswatch not found. Install with: brew install fswatch"
        exit 1
    fi
    
    fswatch -o Sources/ Tests/ | while read f; do
        echo -e "${YELLOW}ðŸ“ Files changed, running tests...${NC}"
        if run_quick_tests; then
            success "âœ… Tests passed!"
        else
            error "âŒ Tests failed!"
        fi
        echo "----------------------------------------"
    done
}

# Continuous mode - run tests in loop
continuous_mode() {
    log "ðŸ”„ Starting continuous mode..."
    log "Press Ctrl+C to stop"
    
    while true; do
        if run_quick_tests; then
            success "âœ… Test cycle complete - waiting 30s"
        else
            error "âŒ Test cycle failed - waiting 30s"
        fi
        
        sleep 30
    done
}

# Pre-commit hook setup
setup_pre_commit_hook() {
    log "ðŸª Setting up pre-commit hook..."
    
    if [ ! -d ".git" ]; then
        error "Not a git repository"
        exit 1
    fi
    
    # Create pre-commit hook
    cat > .git/hooks/pre-commit << 'EOF'
#!/bin/bash
# ForceQUIT Pre-commit Hook - Generated by BUILD_SYSTEM_DEVELOPER

echo "ðŸ§ª Running pre-commit tests..."

# Run test automation in pre-commit mode
if ./test-automation.sh --pre-commit; then
    echo "âœ… Pre-commit tests passed!"
    exit 0
else
    echo "âŒ Pre-commit tests failed!"
    echo "Commit aborted. Fix the issues and try again."
    exit 1
fi
EOF
    
    chmod +x .git/hooks/pre-commit
    success "Pre-commit hook installed"
}

# Main execution
main() {
    echo -e "${BLUE}===============================================================================${NC}"
    echo -e "${GREEN}                ForceQUIT Test Automation${NC}"
    echo -e "${GREEN}                BUILD_SYSTEM_DEVELOPER - SWARM 2.0${NC}"
    echo -e "${BLUE}===============================================================================${NC}"
    
    if [[ "$WATCH_MODE" == true ]]; then
        watch_mode
    elif [[ "$CONTINUOUS_MODE" == true ]]; then
        continuous_mode
    elif [[ "$PRE_COMMIT_MODE" == true ]]; then
        run_quick_tests
        exit $?
    else
        # Default: run tests once and offer to setup pre-commit hook
        if run_quick_tests; then
            success "âœ… All tests passed!"
            
            # Offer to setup pre-commit hook
            if [ -d ".git" ] && [ ! -f ".git/hooks/pre-commit" ]; then
                echo
                echo -e "${YELLOW}ðŸ’¡ Tip: Setup pre-commit hook to run tests automatically?${NC}"
                read -p "Setup pre-commit hook? (y/n): " -n 1 -r
                echo
                if [[ $REPLY =~ ^[Yy]$ ]]; then
                    setup_pre_commit_hook
                fi
            fi
        else
            error "âŒ Some tests failed!"
            exit 1
        fi
    fi
}

# Trap to handle Ctrl+C gracefully
cleanup() {
    echo -e "\n${YELLOW}ðŸ›‘ Test automation stopped${NC}"
    exit 0
}
trap cleanup INT

main "$@"